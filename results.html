<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wine Contest - Rezultaty</title>
  <style>
    body, * {
        font-family: Georgia
    }

    #content {
        max-width: 768px;
        margin: 0 auto;
    }

    @media only screen and (max-width: 700px) {
        .mobile-hide { display: none !important; }
    }
    
    h1, h2, h3 {
        margin: 0;
    }

    a.none {
        text-decoration: none;
    }

    .spacer {
        margin-top: 50px;
    }

    h1.spacer {
        margin-bottom: -50px;
    }

    table {
        width: 100%;
    }

    .wine {
        display: inline-flex;
        gap: 0 10px;
        align-items: center;
        padding: 5px 0;
    }

    .wine .label {
        display: inline-flex;
        flex-direction: column;
    }

    .wine .label .name {
        font-size: 1.4em;
        line-height: 0.8;
        font-weight: bold;
    }

    .wine .label .winery {
        line-height: 0.9;
        margin-bottom: 2px;
    }

    .winner {
        color: #006d00;
        border-image: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(0,109,0,0.5) 50%, rgba(255,255,255,0) 100%);
        border-width: 1px;
        border-style: solid;
        border-image-slice: 1;
        border-top: none;
        border-right: none;
        border-left: none;
    }

    .loser {
        color: #9c0000;
    }

    .vote-rounds {
        max-width: 700px;
        margin: 0 auto;
    }

    .vote-round {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 20px 0;
        gap: 20px;
    }

    .vote {
        width: 50%;
    }

    .vote:first-child {
        text-align: right;
    }

    .vote:first-child img {
        order: 1;
    }

    .notes {
        display: flex;  
        flex-direction: column;
        width: 100%;
        margin-top: -19px;
        background: linear-gradient(179deg, rgb(231 231 231 / 47%) 0%, rgba(255,255,255,0) 100%);
        padding: 10px;
        box-shadow: inset #ffffff 0px -10px 10px 10px;
    }

    .note {
        white-space: pre;
        font-size: 0.8em;
        text-align: center;
        color: #526161;
    }

    .note.left {
        align-self: flex-start
    }

    .note.center {
        align-self: center
    }

    .note.right {
        align-self: flex-end
    }

    table {
        width: 700px;
        margin: 0 auto;
    }

    table thead {
        font-weight: bold;
    }

    table .col-p1 span, table .col-p2 span, table .col-p3 span {
        display: inline-flex;
        width: 25px;
        height: 25px;
        border-radius: 100%;
        align-items: center;
        justify-content: center;
    }

    table .col-center {
        text-align: center;
    }

    table .col-p1 span {
        background-color: #f3df6b;
    }

    table .col-p2 span {
        background-color: #c0c0c0;
    }

    table .col-p3 span {
        background-color: #b59151;
    }

    table.winners-losers td {
        vertical-align: top;
    }

    .judge-avatar {
        display: inline-flex;
        width: 30px;
        height: 30px;
        background-color: #4a4a4a;
        color: white;
        border-radius: 100%;
        font-size: 15px;
        align-items: center;
        justify-content: center;
        font-family: sans-serif;
        font-weight: bold;
        cursor: pointer;
    }

    .wine-list {
        width: 30%;
    }

    .wine-list div {
        display: flex;
        flex-direction: column;
    }

    .loser-sep {
        font-size: 1.5em;
    }
  </style>
</head>

<body>
  <div id="content"></div>
  <script src="common.js"></script>
  <script>
    function getWine(id) {
        return Wines.filter(w => w.id == id)[0];
    }

    function calculateRanking() {
        const wineIdToVotesMap = Judges
            .flatMap(j => j.votes.map(v => { return { ...v, judge: j }}))
            .reduce((map, current) => {
                if (!(current.winner in map)) {
                    map[current.winner] = []
                }
                map[current.winner].push(current);
                return map;
            }, {});

        const wineIdsRanking = Object
            .keys(wineIdToVotesMap)
            .sort((a, b) => { 
                const votesDiff = wineIdToVotesMap[b].length - wineIdToVotesMap[a].length;
                return votesDiff == 0 ? getWine(a).price - getWine(b).price : votesDiff;
            });

        let lastVotes = 0;
        let place = 0;
        return wineIdsRanking
            .map(wineId => {
                const wine = getWine(wineId);
                const votes  = wineIdToVotesMap[wineId];
                if (lastVotes != votes.length) {
                    place += 1;
                    lastVotes = votes.length;
                }
                return { place: place, wine: wine, votes: votes };
            })
    }

    function getWineLabelHtml(wine) {
        return `
        <span class="wine">
            <img src="https://flagcdn.com/24x18/${wine.countryCode}.png"/>
            <span class="label">
                <span class="winery">${wine.winery}</span>
                <span class="name">${wine.name}</span>
            </span>
        </span>`;
    }

    function getJudgeAvatarHtml(judge) {
        return `<span class="judge-avatar" title="${judge.name}">${judge.initials}</span>`;
    }

    function getJudgeAvatarsHtml(judges) {
        return judges.map(j => getJudgeAvatarHtml(j)).join(' ');
    }

    function getRankingRowHtml(rankingRow) {
        return `
        <tr>
            <td class="col-center col-p${rankingRow.place}"><span>${rankingRow.place}</span></td>
            <td>${getWineLabelHtml(rankingRow.wine)}</td>
            <td class="col-center"><a class="none" href="${rankingRow.wine.link}">ðŸ”—</a></td>
            <td class="col-center">${rankingRow.wine.price}</td>
            <td class="col-center">${rankingRow.votes.length}</td>
            <td class="mobile-hide">${getJudgeAvatarsHtml(rankingRow.votes.map(v => v.judge))}</td>
        </tr>`;
    }

    function getRankingRowsHtml(rankingRows) {
        const ranking = calculateRanking();
        return ranking.map(row => getRankingRowHtml(row)).join('\n');
    }

    function getRankingHtml() {
        return `
        <table class="ranking">
            <thead>
                <tr>
                    <td>Miejsce</td>
                    <td>Wino</td>
                    <td>Link</td>
                    <td>PLN</td>
                    <td>GÅ‚osy</td>
                    <td class="mobile-hide"></td>
                </tr>
            </thead>
            <tbody>${getRankingRowsHtml()}</tbody>
        </table>`;
    }
    
    function getJudgeHtml(judge) {
        return `
        <h2 class="spacer">${getJudgeAvatarHtml(judge)} ${judge.name}</h2>
        ${getJudgeVotesTableHtml(judge.votes)}`;
    }

    function getJudgesHtml() {
        return Judges.map(judge => getJudgeHtml(judge)).join('\n');
    }

    function getJudgeVoteRowHtml(vote, round) {
        const leftWine = getWine(vote.left);
        const rightWine = getWine(vote.right);
        const [leftClass, rightClass] = vote.winner == vote.left ? ['winner', 'loser'] : ['loser', 'winner'];
        return `
        <div class="vote-round">
            <div class="vote ${leftClass}">${getWineLabelHtml(leftWine)}</div>
            <div class="vote ${rightClass}">${getWineLabelHtml(rightWine)}</div>
        </div>
        ${getJudgeVoteNoteRowHtmlIfNeeded(vote)}`;
    }

    function getJudgeVoteRowsHtml(votes) {
        return votes.map((vote, round) => getJudgeVoteRowHtml(vote, round + 1)).join('\n');
    }

    function getJudgeVotesTableHtml(votes) {
        return `
        <div class="vote-rounds">
            ${getJudgeVoteRowsHtml(votes)}
        </div>`;
    }

    function getJudgeVoteNoteRowHtmlIfNeeded(vote) {
        return vote.leftNote || vote.note || vote.rightNote
            ? getJudgeVoteNoteRowHtml(vote)
            : '';
    }

    function getVoteHtml(note, type) {
        return note ? `<div class="note ${type}">${note}</div>` : '';
    }

    function getJudgeVoteNoteRowHtml(vote) {
        return `
        <div class="notes">
            ${getVoteHtml(vote.leftNote, 'left')}
            ${getVoteHtml(vote.note, 'center')}
            ${getVoteHtml(vote.rightNote, 'right')}
        </div>`;
    }

    function getWinesHtml() {
        return Wines.map(w => getWineHtml(w)).join('\n');
    }

    function getWineHtml(wine) {
        const link = new URL(wine.link);
        const votes = Judges.flatMap(j => j.votes.map(v => { return { ...v, judge: j }}));
        const winnerVotes = votes.filter(v => v.winner == wine.id);
        const loserVotes = votes.filter(v => v.winner != wine.id && (v.left == wine.id || v.right == wine.id));
        return `
        <h2 class="spacer">${wine.name} ${getJudgeAvatarsHtml(winnerVotes.map(v => v.judge))}</h2>
        <div>
            <div><strong>Numer:</strong> ${wine.id}</div>
            <div><strong>Producent:</strong> ${wine.winery}</div>
            <div><strong>Grona:</strong> ${wine.grapes}</div>
            <div><strong>Rocznik:</strong> ${wine.year}</div>
            <div><strong>Cena:</strong> ${wine.price} PLN</div>
            <div><strong>Pochodzenie:</strong> <img src="https://flagcdn.com/16x12/${wine.countryCode}.png"/>${wine.country}</div>
            <div><strong>Sklep:</strong> <a href="${wine.link}">${link.host}</a></div>
        </div>
        <table class="winners-losers">
            <thead>
                <tr>
                    <td>Gorsze:</td>
                    <td class="mobile-hide"></td>
                    <td class="mobile-hide"></td>
                    <td></td>
                    <td>Lepsze:</td>
                    </td>
                </tr>
            </thead>
            <tr>
                <td class="wine-list">
                    <div>
                        ${winnerVotes.map(vote => {
                            const otherWineId = vote.right == wine.id ? vote.left : vote.right;
                            const otherWine = getWine(otherWineId);
                            return getWineLabelHtml(otherWine);
                        }).join('\n')}
                    </div>
                </td>
                <td class="loser-sep mobile-hide">&lt;</td>
                <td class="wine-list mobile-hide">
                    <div>${getWineLabelHtml(wine)}</div>
                </td>
                <td class="loser-sep">&lt;</td>
                <td class="wine-list">
                    <div>
                        ${loserVotes.map(vote => {
                            const otherWineId = vote.right == wine.id ? vote.left : vote.right;
                            const otherWine = getWine(otherWineId);
                            return getWineLabelHtml(otherWine);
                        }).join('\n')}
                    </div>
                </td>
            </tr>
        </table>`;
    }

    function getHtml() {
        return `
        <h1>Ranking</h1>
        ${getRankingHtml()}
        <h1 class="spacer">SÄ™dziowie</h1>
        ${getJudgesHtml()}
        <h1 class="spacer">Wina</h1>
        ${getWinesHtml()}`;
    }

    var content = document.getElementById("content");
    content.innerHTML = getHtml();
  </script>
</body>

</html>